#!/usr/bin/env python3
"""SilentOakRanch repository helper."""
from __future__ import annotations

import argparse
from pathlib import Path

ROOT = Path(__file__).resolve().parent
EXCLUDED_DIRS = {"node_modules", "vendor", ".git"}
MAX_DEPTH = 5


def iter_tree(base: Path, depth: int = 0):
    if depth > MAX_DEPTH:
        return

    rel_path = base.relative_to(ROOT)
    print("." if rel_path == Path('.') else rel_path.as_posix())

    if depth == MAX_DEPTH:
        return

    entries = sorted(base.iterdir(), key=lambda p: p.name.lower())
    for entry in entries:
        if entry.is_dir():
            if entry.name in EXCLUDED_DIRS:
                continue
            iter_tree(entry, depth + 1)
        else:
            rel_entry = entry.relative_to(ROOT)
            print(rel_entry.as_posix())


def handle_list(args: argparse.Namespace) -> None:
    if not args.all:
        raise SystemExit("The --all flag is required to list the directory tree.")
    iter_tree(ROOT)


def build_parser() -> argparse.ArgumentParser:
    parser = argparse.ArgumentParser(description="SilentOakRanch repository helper")
    subparsers = parser.add_subparsers(dest="command", required=True)

    list_parser = subparsers.add_parser("list", help="List repository contents")
    list_parser.add_argument("--all", action="store_true", help="List all files up to depth 5")
    list_parser.set_defaults(func=handle_list)

    return parser


def main() -> None:
    parser = build_parser()
    args = parser.parse_args()
    args.func(args)


if __name__ == "__main__":
    main()
